name: Update cars snapshot

on:
  schedule:
    - cron: '15 5 * * *'   # daily 05:15 UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Fetch cars JSON (fresh, with retries)
        run: |
          set -euo pipefail
          URL="https://vehicle-api-espm.onrender.com/cars?per_page=25000&page=1&_t=${{ github.run_id }}"
          echo "Downloading: $URL"
          rm -f cars.json
          curl -fsSLo cars.json -H 'Cache-Control: no-cache' --retry 4 --retry-delay 4 "$URL"

          # Basic sanity: must look like JSON and contain at least one known key
          if ! head -c 1 cars.json | grep -q '^\[' && ! head -c 1 cars.json | grep -q '^{'; then
            echo "::error ::cars.json does not start with [ or {"
            head -c 500 cars.json || true
            exit 1
          fi

          # Required keys (add/remove as you wish)
          REQUIRED_KEYS=(
            '"latitude"'
            '"longitude"'
            '"price_gbp"'
            '"vehicle_registration_mark"'
            '"performance_maxspeed_mph"'
            '"performance_acceleration_zero_to_60_mph"'
            '"efficiency_combined_mpg"'
            '"images_count"'
            '"options"'
            '"features"'
            '"seller_comments"'
          )

          missing=0
          for k in "${REQUIRED_KEYS[@]}"; do
            if ! grep -q "$k" cars.json; then
              echo "::warning ::Missing key in cars.json: $k"
              missing=$((missing+1))
            fi
          done

          if [ "$missing" -gt 0 ]; then
            echo "::error ::cars.json is missing $missing required keys. Aborting so you notice."
            head -c 1200 cars.json || true
            exit 1
          fi

          echo "cars.json OK ($(wc -c < cars.json) bytes)"

      - name: Commit if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Daily snapshot"
          file_pattern: cars.json
